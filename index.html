<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Swamp-Hop // Borderlands Nights</title>
  <style>
    :root{
      --bg:#0b0e14;
      --ink:#0a0a0a;
      --paper:#f7f1d5;
      --acid:#b6ff3b;
      --neon:#39d6ff;
      --hot:#ff3bb6;
      --warn:#ffcc00;
      --muted:#9aa3b2;
      --glass: rgba(10,12,18,.58);
      --glass2: rgba(10,12,18,.72);
      --stroke: rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --round: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 20% 0%, rgba(57,214,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 80% 10%, rgba(255,59,182,.14), transparent 60%),
                  radial-gradient(1000px 800px at 50% 100%, rgba(182,255,59,.10), transparent 60%),
                  var(--bg);
      color:#e9eef8;
      overflow:hidden;
      -webkit-tap-highlight-color:transparent;
      -webkit-touch-callout:none;
      user-select:none;
      touch-action:pan-y;
    }

    /* === Video filmstrip background === */
    .bg-wrap{
      position:fixed; inset:0;
      z-index:-3;
      background:#000;
    }
    video#bgVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: contrast(1.05) saturate(1.12) brightness(.62);
      transform: scale(1.02);
    }
    video#bgVideo.window-mode{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%) scale(1);
      width:640px;
      height:360px;
      max-width:90vw;
      max-height:50vh;
      z-index:1000;
      border:2px solid rgba(182,255,59,.4);
      box-shadow:0 0 40px rgba(0,0,0,.8);
      border-radius:12px;
      filter:contrast(1.1) saturate(1.15) brightness(.75);
    }
    /* film grain + vignette */
    .grain, .vignette, .filmstrip, .inklines{
      position:absolute; inset:0; pointer-events:none;
    }
    .vignette{
      background: radial-gradient(1200px 900px at 50% 40%, transparent 10%, rgba(0,0,0,.65) 70%, rgba(0,0,0,.90) 100%);
      z-index:-2;
    }
    .grain{
      z-index:-2;
      opacity:.18;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 3px);
      mix-blend-mode:overlay;
      animation: grainMove 8s steps(10) infinite;
    }
    @keyframes grainMove{
      0%{transform:translate3d(0,0,0)}
      25%{transform:translate3d(-2%,1%,0)}
      50%{transform:translate3d(1%,-2%,0)}
      75%{transform:translate3d(2%,2%,0)}
      100%{transform:translate3d(0,0,0)}
    }

    /* Filmstrip perforations + frame lines */
    .filmstrip{
      z-index:-2;
      opacity:.40;
      background:
        linear-gradient(to right, rgba(0,0,0,.45), rgba(0,0,0,.15) 12%, rgba(0,0,0,.15) 88%, rgba(0,0,0,.45)),
        repeating-linear-gradient(to bottom,
          rgba(255,255,255,.08), rgba(255,255,255,.08) 2px,
          transparent 2px, transparent 46px),
        repeating-linear-gradient(to right,
          rgba(255,255,255,.06), rgba(255,255,255,.06) 2px,
          transparent 2px, transparent 120px);
      mix-blend-mode:overlay;
    }
    /* perforation holes (left/right) */
    .filmstrip:before, .filmstrip:after{
      content:"";
      position:absolute; top:0; bottom:0; width:74px;
      background:
        repeating-linear-gradient(to bottom,
          rgba(0,0,0,.75), rgba(0,0,0,.75) 16px,
          transparent 16px, transparent 40px);
      mask-image: repeating-linear-gradient(to bottom,
        transparent 0, transparent 12px,
        #000 12px, #000 28px,
        transparent 28px, transparent 40px);
      opacity:.55;
    }
    .filmstrip:before{left:0}
    .filmstrip:after{right:0}

    /* Inky outlines (cel-shade vibe) */
    .inklines{
      z-index:-2;
      opacity:.35;
      background:
        radial-gradient(800px 500px at 15% 30%, rgba(0,0,0,.35), transparent 60%),
        radial-gradient(900px 600px at 85% 35%, rgba(0,0,0,.28), transparent 60%),
        linear-gradient(transparent, rgba(0,0,0,.30));
      mix-blend-mode:multiply;
    }

    /* === Layout === */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:14px;
      padding:18px;
      max-width: 1180px;
      margin:0 auto;
    }

    /* Header */
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px;
      border-radius: var(--round);
      background: linear-gradient(180deg, rgba(10,12,18,.72), rgba(10,12,18,.42));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .brand:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 260px at 20% 0%, rgba(182,255,59,.18), transparent 55%),
                  radial-gradient(520px 260px at 90% 30%, rgba(57,214,255,.16), transparent 55%);
      opacity:.95;
      pointer-events:none;
    }
    .logo{
      width:44px; height:44px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(182,255,59,.18), rgba(57,214,255,.12));
      border: 2px solid rgba(255,255,255,.18);
      position:relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      flex:0 0 auto;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(transparent 58%, rgba(0,0,0,.20)),
        repeating-linear-gradient( to bottom, rgba(255,255,255,.18), rgba(255,255,255,.18) 2px, transparent 2px, transparent 10px);
      opacity:.55;
      mix-blend-mode:overlay;
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: var(--paper);
      font-family: var(--mono);
      position:relative;
      z-index:1;
      line-height:1.2;
    }
    .brand .sub{
      font-size:12px;
      color: rgba(233,238,248,.78);
      letter-spacing:.06em;
      position:relative;
      z-index:1;
      margin-top:2px;
    }

    /* Borderlands drip bar */
    .dripbar{
      flex:1;
      border-radius: var(--round);
      background: linear-gradient(180deg, rgba(10,12,18,.75), rgba(10,12,18,.40));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
      min-height: 62px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      gap:10px;
    }
    .dripbar:before{
      /* neon stripe */
      content:"";
      position:absolute; left:-40px; top:10px; height:3px; width:180px;
      background: linear-gradient(90deg, transparent, var(--acid), transparent);
      transform: rotate(-8deg);
      opacity:.85;
      filter: blur(.2px);
      pointer-events:none;
    }
    .dripbar:after{
      /* drip SVG-ish effect using mask gradients */
      content:"";
      position:absolute; left:0; right:0; top:0; height:64px;
      background:
        radial-gradient(18px 26px at 8% 0%, rgba(255,204,0,.95) 50%, transparent 52%),
        radial-gradient(22px 34px at 22% 0%, rgba(255,204,0,.95) 50%, transparent 52%),
        radial-gradient(14px 22px at 38% 0%, rgba(255,204,0,.95) 50%, transparent 52%),
        radial-gradient(26px 40px at 55% 0%, rgba(255,204,0,.95) 50%, transparent 52%),
        radial-gradient(16px 26px at 74% 0%, rgba(255,204,0,.95) 50%, transparent 52%),
        radial-gradient(20px 32px at 90% 0%, rgba(255,204,0,.95) 50%, transparent 52%),
        linear-gradient(to bottom, rgba(255,204,0,.92), rgba(255,204,0,.05));
      opacity:.18;
      mix-blend-mode: screen;
      pointer-events:none;
      filter: saturate(1.2);
    }

    .pill{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      position:relative;
      overflow:hidden;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.06em;
    }
    .pill b{color:var(--paper)}
    .pill small{color:rgba(233,238,248,.72)}
    .btn{
      user-select:none;
      cursor:pointer;
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      color:#e9eef8;
      font-family: var(--mono);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{background: rgba(0,0,0,.34); border-color: rgba(255,255,255,.20)}
    .btn:active{transform: translateY(1px) scale(.995)}
    .btn.acid{border-color: rgba(182,255,59,.35)}
    .btn.acid:hover{background: rgba(182,255,59,.08)}
    .btn.warn{border-color: rgba(255,204,0,.35)}
    .btn.warn:hover{background: rgba(255,204,0,.08)}

    /* Main grid */
    main{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      min-height:0;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr; }
      .dripbar{min-height: 72px;}
    }

    /* === Mobile Optimizations === */
    @media (max-width: 768px){
      .app{
        padding:12px;
        gap:10px;
      }

      header{
        flex-direction:column;
        gap:10px;
      }

      .brand{
        padding:8px 12px;
      }
      .brand h1{
        font-size:12px;
      }
      .brand .sub{
        font-size:11px;
      }

      .dripbar{
        flex-direction:column;
        min-height:auto;
        padding:8px 10px;
      }
      .dripbar > div:last-child{
        width:100%;
        justify-content:flex-start;
      }

      .btn{
        padding:12px 14px;
        font-size:11px;
        min-height:44px;
        min-width:44px;
      }

      .panel .head{
        padding:10px 12px;
      }
      .panel .body{
        padding:12px;
      }

      .title{
        font-size:20px;
      }

      .controls{
        flex-direction:column;
      }
      .slider{
        width:100%;
        min-width:auto;
      }

      .bars{
        bottom:20px;
        left:20px;
        width:200px;
      }

      .combat-text{
        top:20px;
        right:20px;
        font-size:11px;
        padding:6px 10px;
      }

      .loot-ping{
        bottom:80px;
        font-size:10px;
        padding:5px 10px;
      }

      video#bgVideo.window-mode{
        width:90vw;
        height:auto;
        max-height:40vh;
      }

      footer{
        flex-direction:column;
        gap:8px;
        font-size:11px;
      }
    }

    @media (max-width: 480px){
      .app{
        padding:8px;
        gap:8px;
      }

      .brand h1{
        font-size:11px;
        letter-spacing:.12em;
      }
      .brand .sub{
        font-size:10px;
      }
      .logo{
        width:36px;
        height:36px;
      }

      .btn{
        padding:10px 12px;
        font-size:10px;
      }

      .title{
        font-size:18px;
      }

      .bars{
        width:160px;
        bottom:15px;
        left:15px;
      }

      .shield, .health{
        height:12px;
        margin-bottom:6px;
      }

      .combat-text{
        font-size:10px;
        padding:5px 8px;
      }

      .loot-ping{
        font-size:9px;
        padding:4px 8px;
      }

      video#bgVideo.window-mode{
        width:95vw;
        max-height:35vh;
      }
    }

    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse){
      .btn:active{
        transform: translateY(2px) scale(.98);
        background: rgba(0,0,0,.40);
      }

      .track:active{
        background: rgba(255,255,255,.08);
      }

      .bar:active .fill{
        opacity:.9;
      }
    }

    .panel{
      border-radius: var(--round);
      background: linear-gradient(180deg, rgba(10,12,18,.78), rgba(10,12,18,.46));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      min-height:0;
      position:relative;
    }
    .panel .head{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
    }
    .panel .head h2{
      margin:0;
      font-size: 12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-family: var(--mono);
      color: rgba(233,238,248,.85);
    }
    .panel .body{
      padding:14px;
      min-height:0;
      height:100%;
    }

    /* Now Playing card */
    .np{
      display:grid;
      grid-template-rows: auto auto auto 1fr;
      gap:12px;
      height:100%;
      min-height:0;
    }
    .title{
      font-size: 26px;
      line-height:1.08;
      margin:0;
      letter-spacing:.01em;
      text-shadow: 0 2px 0 rgba(0,0,0,.55);
    }
    .meta{
      display:flex; flex-wrap:wrap; gap:8px;
      color: rgba(233,238,248,.78);
      font-family: var(--mono);
      font-size:12px;
      letter-spacing:.06em;
    }
    .chip{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }

    /* Progress */
    .progress-wrap{
      display:grid;
      gap:10px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      cursor:pointer;
      position:relative;
      touch-action:none;
    }
    @media (max-width: 768px){
      .bar{
        height:16px;
        min-height:44px;
        padding:14px 0;
      }
    }
    .bar > .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(182,255,59,.95), rgba(57,214,255,.85));
      box-shadow: 0 0 24px rgba(182,255,59,.18);
    }
    .bar:after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient( to right, rgba(0,0,0,.18), rgba(0,0,0,.18) 8px, transparent 8px, transparent 16px);
      opacity:.25;
      pointer-events:none;
      mix-blend-mode: multiply;
    }
    .time{
      display:flex; justify-content:space-between;
      font-family: var(--mono);
      font-size:12px;
      color: rgba(233,238,248,.72);
    }

    /* Controls */
    .controls{
      display:flex; flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .controls .btn{padding:10px 12px}
    .slider{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      min-width: 260px;
      flex:1;
    }
    .slider label{
      font-family: var(--mono);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(233,238,248,.72);
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--acid);
    }

    /* Lyrics / Notes area */
    .notes{
      height:100%;
      min-height:0;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:12px;
      overflow:auto;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.55;
      color: rgba(233,238,248,.78);
    }
    .notes b{color: var(--paper)}
    .notes .tag{color: rgba(182,255,59,.85)}
    .notes .hint{color: rgba(57,214,255,.85)}

    /* Playlist */
    .list{
      height: calc(100% - 0px);
      overflow:auto;
      padding:0;
      margin:0;
      list-style:none;
    }
    .track{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      transition: background .15s ease;
      position:relative;
    }
    .track:hover{background: rgba(255,255,255,.04)}
    .track.active{
      background: linear-gradient(90deg, rgba(182,255,59,.12), rgba(57,214,255,.06));
    }
    .track .name{
      font-weight:700;
      letter-spacing:.01em;
    }
    .track .desc{
      font-size:12px;
      color: rgba(233,238,248,.70);
      margin-top:4px;
      font-family: var(--mono);
    }
    .track .dur{
      font-family: var(--mono);
      font-size:12px;
      color: rgba(233,238,248,.65);
      align-self:center;
    }
    .track.active:before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:4px;
      background: linear-gradient(180deg, var(--acid), var(--neon));
      box-shadow: 0 0 18px rgba(182,255,59,.22);
    }

    /* Footer help */
    footer{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      color: rgba(233,238,248,.65);
      font-family: var(--mono);
      font-size:12px;
      letter-spacing:.04em;
      padding:4px 2px;
    }
    .kbd{
      padding:4px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(233,238,248,.78);
    }

    /* Scrollbars (subtle) */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius: 999px}
    ::-webkit-scrollbar-track{background: rgba(0,0,0,.18)}

    /* Mobile scroll improvements */
    @media (max-width: 768px){
      .list{
        -webkit-overflow-scrolling:touch;
        overscroll-behavior:contain;
      }
      .notes{
        -webkit-overflow-scrolling:touch;
        overscroll-behavior:contain;
      }
    }

    /* === HUD Overlay === */
    .hud{
      position:absolute;
      inset:0;
      pointer-events:none;
      font-family: var(--mono);
    }

    .bars{
      position:absolute;
      bottom:40px;
      left:40px;
      width:260px;
    }

    .shield, .health{
      height:14px;
      border-radius:999px;
      background:rgba(255,255,255,.15);
      margin-bottom:8px;
      overflow:hidden;
    }

    .shield .fill{
      height:100%;
      width:85%;
      background:linear-gradient(90deg,#39d6ff,#7cf6ff);
      box-shadow:0 0 12px rgba(57,214,255,.6);
    }

    .health .fill{
      height:100%;
      width:70%;
      background:linear-gradient(90deg,#ff3b3b,#ff7a7a);
      box-shadow:0 0 12px rgba(255,59,59,.6);
    }

    .combat-text{
      position:absolute;
      top:40px;
      right:40px;
      padding:8px 14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.35);
      color:#ffcc00;
      letter-spacing:.2em;
      font-size:12px;
      animation:flicker 3s infinite;
    }

    .loot-ping{
      position:absolute;
      bottom:120px;
      right:50%;
      transform:translateX(50%);
      padding:6px 12px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(182,255,59,.45);
      color:#b6ff3b;
      font-size:11px;
      letter-spacing:.18em;
      animation:pulse 2.5s infinite;
    }

    @keyframes pulse{
      0%,100%{opacity:.3}
      50%{opacity:1}
    }

    @keyframes flicker{
      0%,100%{opacity:.6}
      45%{opacity:1}
      48%{opacity:.3}
    }
  </style>
</head>
<body>
  <div class="bg-wrap">
    <!-- Video background - swaps per track (1.mp4, 2.mp4, etc.) -->
    <video id="bgVideo" autoplay muted playsinline preload="auto" webkit-playsinline crossorigin="anonymous" disablePictureInPicture controlsList="nodownload">
      <source src="1.mp4" type="video/mp4" />
    </video>
    <div class="hud">
      <div class="bars">
        <div class="shield">
          <div class="fill" id="shieldBar"></div>
        </div>
        <div class="health">
          <div class="fill" id="healthBar"></div>
        </div>
      </div>

      <div class="combat-text" id="combatText">ENGAGED</div>

      <div class="loot-ping" id="lootPing">LOOT NEARBY</div>
    </div>
    <div class="filmstrip"></div>
    <div class="grain"></div>
    <div class="inklines"></div>
    <div class="vignette"></div>
  </div>

  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="position:relative;z-index:1">
          <h1>Swamp-Hop // Borderlands Nights</h1>
          <div class="sub">Playlist Player ¬∑ MP4 Filmstrip ¬∑ Drip UI</div>
        </div>
      </div>

      <div class="dripbar">
        <div class="pill"><b id="statusDot">‚óè</b> <small id="statusText">Ready</small></div>
        <div class="pill"><b>MODE</b> <small id="modeText">Loop</small></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn warn" id="btnShuffle" title="Shuffle">Shuffle</button>
          <button class="btn" id="btnLoop" title="Toggle loop">Loop: On</button>
          <button class="btn" id="btnWindowMode" title="Toggle video window mode">Window: Off</button>
          <button class="btn acid" id="btnBgToggle" title="Toggle video background">BG: On</button>
          <button class="btn warn" id="btnSlowMode" title="Slow internet settings">Slow Mode</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Now Playing -->
      <section class="panel">
        <div class="head">
          <h2>Now Playing</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" id="btnPrev" title="Previous (‚Üê)">Prev</button>
            <button class="btn acid" id="btnPlay" title="Play/Pause (Space)">Play</button>
            <button class="btn" id="btnNext" title="Next (‚Üí)">Next</button>
          </div>
        </div>
        <div class="body">
          <div class="np">
            <div>
              <h3 class="title" id="trackTitle">‚Äî</h3>
              <div class="meta" id="trackMeta">
                <span class="chip">Swamp-Hop</span>
                <span class="chip">Halftime</span>
                <span class="chip">Neon Grit</span>
              </div>
            </div>

            <div class="progress-wrap">
              <div class="bar" id="bar" title="Seek">
                <div class="fill" id="fill"></div>
              </div>
              <div class="time">
                <span id="tCur">0:00</span>
                <span id="tDur">0:00</span>
              </div>
            </div>

            <div class="controls">
              <div class="slider">
                <label for="vol">Vol</label>
                <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85" />
                <span id="volVal" style="font-family:var(--mono);opacity:.75">85%</span>
              </div>
              <button class="btn" id="btnRew" title="Back 10s (J)">-10s</button>
              <button class="btn" id="btnFwd" title="Forward 10s (L)">+10s</button>
              <button class="btn" id="btnCopy" title="Copy track info">Copy</button>
            </div>

            <div class="notes" id="notes">
              <b>Drop your files in this folder:</b> <span class="hint">1.mp4, 2.mp4, etc.</span> + audio files. <br/>
              <b>Hotkeys:</b> <span class="kbd">Space</span> play/pause ¬∑ <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> prev/next ¬∑ <span class="kbd">J</span>/<span class="kbd">L</span> seek ¬∑ <span class="kbd">M</span> mute. <br/><br/>
              <span class="tag">TIP:</span> Videos play at <b>0.85x</b> speed. Use <b>Slow Mode</b> button for low bandwidth options.
            </div>
            
            <!-- Slow Internet Settings Panel (hidden by default) -->
            <div id="slowModePanel" style="display:none; margin-top:12px; padding:12px; border-radius:12px; background:rgba(0,0,0,.25); border:1px solid rgba(255,204,0,.3);">
              <h4 style="margin:0 0 10px 0; font-size:12px; color:#ffcc00; letter-spacing:.1em;">SLOW INTERNET OPTIONS</h4>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer;">
                  <input type="checkbox" id="optDisableVideo" />
                  <span>Disable video background (audio only)</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer;">
                  <input type="checkbox" id="optLazyLoad" checked />
                  <span>Lazy load videos (load on demand)</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer;">
                  <input type="checkbox" id="optLowQuality" />
                  <span>Reduce video quality (if available)</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; cursor:pointer;">
                  <input type="checkbox" id="optPreloadAudio" />
                  <span>Preload next audio track</span>
                </label>
                <div style="font-size:10px; color:rgba(233,238,248,.6); margin-top:4px;">
                  <span id="bandwidthStatus">Detecting connection speed...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Playlist -->
      <section class="panel">
        <div class="head">
          <h2>Playlist</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" id="btnAddDemo" title="Adds demo items">Demo</button>
            <button class="btn warn" id="btnClearMem" title="Clear saved state">Reset</button>
          </div>
        </div>
        <div class="body" style="padding:0">
          <ul class="list" id="list"></ul>
        </div>
      </section>
    </main>

    <footer>
      <div>üß™ Borderlands-style drip UI ¬∑ üßº Offline-friendly ¬∑ üíæ Saves state locally</div>
      <div>
        <span class="kbd">Space</span>
        <span class="kbd">‚Üê</span>
        <span class="kbd">‚Üí</span>
        <span class="kbd">J</span>
        <span class="kbd">L</span>
        <span class="kbd">M</span>
      </div>
    </footer>

    <!-- Audio element -->
    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    // ====== CONFIG: Edit these tracks ======
    // Put your MP3/WAV in the same folder (or use relative paths).
    const TRACKS = [
      {
        title: "Loot Dust n Lag (Mayhem Build)",
        artist: "Swamp-Hop Crew",
        mood: "Neon chaos ¬∑ mayhem grind",
        src: "loot_dust_n_lag_(mayhem_build).mp3",
        notes: "Heavy 808 ¬∑ vault doors ¬∑ max mayhem."
      },
      {
        title: "Hold Up ‚Äî Don't Start It",
        artist: "Adult Children Division",
        mood: "Comedy chaos ¬∑ couch co-op",
        src: "hold_up_dont_start_it.mp3",
        notes: "Menu panic ¬∑ friendly fire ¬∑ respawn shame."
      },
      {
        title: "Loot Dust n Lag",
        artist: "Swamp-Hop Crew",
        mood: "Late-night grind ¬∑ tunnel vision",
        src: "loot_dust_n_lag.mp3",
        notes: "Smooth runback energy."
      },
      {
        title: "Green Beam Fever",
        artist: "Swamp-Hop Crew",
        mood: "Addictive loot chase ¬∑ bop",
        src: "green_beam_fever.mp3",
        notes: "Shiny drop syndrome."
      },
      {
        title: "Wait ‚Äî What Was We Doin'?",
        artist: "High Alert Squad",
        mood: "Distracted haze ¬∑ side quest spiral",
        src: "wait_what_was_we_doin_.mp3",
        notes: "Mid-fight looting while getting shot."
      },
      {
        title: "Godroll ‚Äî Don't Touch It",
        artist: "Swamp-Hop Crew",
        mood: "Perfect drop tension ¬∑ legendary chase",
        src: "godroll_dont_touch_it.mp3",
        notes: "That one perfect roll ¬∑ don't jinx it."
      },
      {
        title: "Bro Still in Menu",
        artist: "Adult Children Division",
        mood: "Loading screen anxiety ¬∑ menu paralysis",
        src: "bro_still_in_menu.mp3",
        notes: "5 minutes later ¬∑ still configuring."
      },
      {
        title: "Bro in Menu",
        artist: "Adult Children Division",
        mood: "Menu navigation ¬∑ option paralysis",
        src: "bro_in_menu.mp3",
        notes: "Can't decide ¬∑ too many choices."
      },
      {
        title: "Legendary Hunt",
        artist: "Swamp-Hop Crew",
        mood: "Boss farming ¬∑ drop hunting ¬∑ grind mode",
        src: "legendary_hunt.mp3",
        notes: "Endless runs ¬∑ RNG prayers ¬∑ orange beams."
      }
    ];

    // Video cycling - loops through all videos independently
    const VIDEO_COUNT = 21;
    let currentVideoIndex = 1;

    function loadNextVideo(forceLoad = false){
      if (!bgVideo) return;
      
      // Check if video should be disabled
      if (state.slowMode.disableVideo) {
        bgVideo.style.display = 'none';
        return;
      }
      
      // Lazy loading: only load if not in lazy mode or if forced
      if (state.slowMode.lazyLoad && !forceLoad && !state.bg && !state.windowMode) {
        // Don't load video yet, wait for user to enable it
        return;
      }
      
      // Set up error handler before loading
      bgVideo.onerror = () => {
        console.warn(`Video ${currentVideoIndex}.mp4 failed to load, skipping to next`);
        // Skip to next video on error
        currentVideoIndex = (currentVideoIndex % VIDEO_COUNT) + 1;
        // Prevent infinite loop if all videos fail
        const attempts = bgVideo.dataset.errorCount = (parseInt(bgVideo.dataset.errorCount || '0') + 1);
        if (attempts < VIDEO_COUNT) {
          setTimeout(() => loadNextVideo(true), 100);
        } else {
          console.error("Multiple video load failures. Stopping video cycling.");
          if (statusText) setStatus("error", "Video files not found. Check file paths.");
        }
      };
      
      // Reset error count on successful load
      bgVideo.onloadeddata = () => {
        bgVideo.dataset.errorCount = '0';
      };
      
      // Load current video with quality settings
      let videoSrc = `${currentVideoIndex}.mp4`;
      if (state.slowMode.lowQuality) {
        // Try lower quality version if available (e.g., 1_low.mp4)
        videoSrc = `${currentVideoIndex}_low.mp4`;
        bgVideo.onerror = () => {
          // Fallback to normal quality if low quality doesn't exist
          bgVideo.src = `${currentVideoIndex}.mp4`;
          bgVideo.load();
        };
      }
      
      bgVideo.src = videoSrc;
      bgVideo.load();
      bgVideo.playbackRate = 0.85;
      
      // Set preload based on settings
      bgVideo.preload = state.slowMode.lazyLoad ? 'none' : 'auto';
      
      bgVideo.play().catch((err) => {
        console.warn("Video play failed:", err);
      });
      updateVideoDisplay();
      
      // Prepare next video index (1-21, cycles back to 1)
      currentVideoIndex = (currentVideoIndex % VIDEO_COUNT) + 1;
    }

    // ====== State / Elements ======
    const $ = (id) => {
      const el = document.getElementById(id);
      if (!el) {
        console.warn(`Element #${id} not found`);
      }
      return el;
    };
    
    const audio = $("audio");
    const bgVideo = $("bgVideo");
    
    // Early exit if critical elements missing
    if (!audio || !bgVideo) {
      console.error("Critical elements missing. Cannot initialize player.");
      document.body.innerHTML = '<div style="padding:20px;color:#ff3b3b;font-family:monospace;">Error: Required elements not found. Please refresh the page.</div>';
    }

    const listEl = $("list");
    const titleEl = $("trackTitle");
    const metaEl = $("trackMeta");
    const notesEl = $("notes");

    const btnPlay = $("btnPlay");
    const btnPrev = $("btnPrev");
    const btnNext = $("btnNext");
    const btnRew = $("btnRew");
    const btnFwd = $("btnFwd");

    const bar = $("bar");
    const fill = $("fill");
    const tCur = $("tCur");
    const tDur = $("tDur");

    const vol = $("vol");
    const volVal = $("volVal");

    const btnLoop = $("btnLoop");
    const btnShuffle = $("btnShuffle");
    const btnBgToggle = $("btnBgToggle");
    const btnWindowMode = $("btnWindowMode");

    const statusDot = $("statusDot");
    const statusText = $("statusText");
    const modeText = $("modeText");

    const btnCopy = $("btnCopy");
    const btnClearMem = $("btnClearMem");
    const btnAddDemo = $("btnAddDemo");
    const btnSlowMode = $("btnSlowMode");
    
    // Slow internet options elements
    const slowModePanel = $("slowModePanel");
    const optDisableVideo = $("optDisableVideo");
    const optLazyLoad = $("optLazyLoad");
    const optLowQuality = $("optLowQuality");
    const optPreloadAudio = $("optPreloadAudio");
    const bandwidthStatus = $("bandwidthStatus");

    const KEY = "swamphop_borderlands_player_v1";
    const state = {
      idx: 0,
      loop: true,
      bg: true,
      windowMode: false,
      shuffled: false,
      order: [...TRACKS.keys()],
      volume: 0.85,
      slowMode: {
        disableVideo: false,
        lazyLoad: true,
        lowQuality: false,
        preloadAudio: false,
        bandwidth: 'unknown'
      }
    };

    // ====== Helpers ======
    function fmtTime(sec){
      if (!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function setStatus(kind, text){
      // kind: "ready" | "play" | "pause" | "error"
      if (!statusDot || !statusText) return;
      const map = {
        ready: { dot:"‚óè", color:"rgba(182,255,59,.95)" },
        play:  { dot:"‚óè", color:"rgba(57,214,255,.95)" },
        pause: { dot:"‚óè", color:"rgba(255,204,0,.95)" },
        error: { dot:"‚óè", color:"rgba(255,59,182,.95)" }
      };
      statusDot.textContent = map[kind]?.dot ?? "‚óè";
      statusDot.style.color = map[kind]?.color ?? "rgba(233,238,248,.85)";
      statusText.textContent = text || "‚Äî";
    }

    // Debounced save to prevent excessive writes
    let saveTimeout = null;
    function save(){
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        try {
          if (typeof localStorage === 'undefined') return;
          
          const payload = {
            ...state,
            currentTime: audio ? (audio.currentTime || 0) : 0,
            idx: state.idx,
            order: state.order,
            loop: state.loop,
            bg: state.bg,
            windowMode: state.windowMode,
            shuffled: state.shuffled,
            volume: state.volume,
            slowMode: state.slowMode
          };
          localStorage.setItem(KEY, JSON.stringify(payload));
        } catch(e) {
          console.error("Failed to save state:", e);
        }
      }, 300); // Debounce to 300ms
    }

    function load(){
      try{
        // Check localStorage availability
        if (typeof localStorage === 'undefined') {
          console.warn("localStorage not available");
          return;
        }
        
        const raw = localStorage.getItem(KEY);
        if(!raw) return;
        
        const d = JSON.parse(raw);
        
        // Validate state structure
        if (!d || typeof d !== 'object') {
          console.warn("Invalid state structure, using defaults");
          return;
        }
        
        // Validate and restore each property
        if(typeof d.idx === "number" && d.idx >= 0 && d.idx < TRACKS.length) {
          state.idx = d.idx;
        }
        
        if(Array.isArray(d.order) && d.order.length === TRACKS.length) {
          // Validate order array contains valid indices
          const validOrder = d.order.every(idx => typeof idx === 'number' && idx >= 0 && idx < TRACKS.length);
          if (validOrder) {
            state.order = d.order;
          }
        }
        
        if(typeof d.loop === "boolean") state.loop = d.loop;
        if(typeof d.bg === "boolean") state.bg = d.bg;
        if(typeof d.windowMode === "boolean") state.windowMode = d.windowMode;
        if(typeof d.shuffled === "boolean") state.shuffled = d.shuffled;
        if(typeof d.volume === "number" && d.volume >= 0 && d.volume <= 1) {
          state.volume = d.volume;
        }
        
        // restore currentTime after metadata loads
        if(typeof d.currentTime === "number" && d.currentTime >= 0) {
          state._restoreTime = d.currentTime;
        }
      }catch(e){
        console.error("Failed to load state:", e);
        // Reset to defaults on error
        try {
          localStorage.removeItem(KEY);
        } catch(clearErr) {
          console.error("Failed to clear corrupted state:", clearErr);
        }
      }
    }

    function clampIdx(i){
      if(i < 0) return 0;
      if(i >= TRACKS.length) return TRACKS.length - 1;
      return i;
    }

    function currentRealIndex(){
      return state.order[state.idx] ?? state.idx;
    }

    function renderList(){
      if (!listEl) return;
      if (!TRACKS || TRACKS.length === 0) {
        listEl.innerHTML = "<li style='padding:20px;text-align:center;color:rgba(233,238,248,.65);'>No tracks available</li>";
        if (modeText) modeText.textContent = "No Tracks";
        return;
      }
      
      listEl.innerHTML = "";
      for(let i=0;i<TRACKS.length;i++){
        const real = state.order[i];
        if (real === undefined || real < 0 || real >= TRACKS.length) continue;
        
        const tr = TRACKS[real];
        if (!tr || !tr.title) continue;
        
        const li = document.createElement("li");
        li.className = "track" + (i === state.idx ? " active" : "");
        li.dataset.idx = String(i);

        const left = document.createElement("div");
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = tr.title || "Unknown";
        const desc = document.createElement("div");
        desc.className = "desc";
        desc.textContent = `${tr.artist || "Unknown"} ¬∑ ${tr.mood || "‚Äî"}`;
        left.appendChild(name);
        left.appendChild(desc);

        const dur = document.createElement("div");
        dur.className = "dur";
        dur.textContent = "‚Äî";

        li.appendChild(left);
        li.appendChild(dur);

        li.addEventListener("click", () => {
          state.idx = i;
          loadTrack(true);
        });

        listEl.appendChild(li);
      }
      modeText.textContent = state.loop ? "Loop" : "Linear";
    }

    function updateActiveRow(){
      if (!listEl) return;
      [...listEl.querySelectorAll(".track")].forEach((el) => {
        el.classList.toggle("active", Number(el.dataset.idx) === state.idx);
      });
    }

    function loadTrack(autoplay=false){
      if (!TRACKS || TRACKS.length === 0) {
        setStatus("error", "No tracks available");
        return;
      }
      
      if (!audio) {
        setStatus("error", "Audio element not found");
        return;
      }
      
      const realIdx = currentRealIndex();
      if (realIdx < 0 || realIdx >= TRACKS.length) {
        setStatus("error", "Invalid track index");
        return;
      }
      
      const tr = TRACKS[realIdx];
      if (!tr || !tr.src) {
        setStatus("error", "Track data invalid");
        return;
      }
      
      if (titleEl) titleEl.textContent = tr.title || "Unknown";

      if (metaEl) metaEl.innerHTML = "";
      const chips = [
        `Artist: ${tr.artist || "Unknown"}`,
        tr.mood || "‚Äî",
        state.shuffled ? "Shuffle: On" : "Shuffle: Off"
      ];
      chips.forEach(txt=>{
        const s = document.createElement("span");
        s.className = "chip";
        s.textContent = txt;
        metaEl.appendChild(s);
      });

      notesEl.innerHTML = `
        <b>Track Notes:</b> ${escapeHtml(tr.notes || "‚Äî")}<br/>
        <b>File:</b> <span class="hint">${escapeHtml(tr.src)}</span><br/><br/>
        <span class="tag">Hotkeys:</span> <span class="kbd">Space</span> play/pause ¬∑ <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> prev/next ¬∑ <span class="kbd">J</span>/<span class="kbd">L</span> seek ¬∑ <span class="kbd">M</span> mute.<br/>
        <span class="tag">BG:</span> MP4 video running at <b>0.85x</b> (toggle in header). Window mode available.
      `;

      // Handle filenames with special characters
      audio.src = encodeURI(tr.src);
      audio.preload = state.slowMode.preloadAudio ? 'auto' : 'metadata';
      audio.load();
      updateActiveRow();
      setStatus("ready", "Loaded: " + tr.title);
      if (btnPlay) btnPlay.textContent = "Play";
      
      // Preload next track if enabled
      preloadNextAudio();

      // Restore time once metadata is ready
      const restore = state._restoreTime || 0;
      state._restoreTime = 0;
      audio.onloadedmetadata = () => {
        tDur.textContent = fmtTime(audio.duration);
        if(restore > 0 && restore < audio.duration - 0.5){
          audio.currentTime = restore;
        }
        if(autoplay) play();
        save();
      };

      audio.onerror = (e) => {
        setStatus("error", `Audio failed to load: ${tr.src}. Check file path.`);
        console.error("Audio load error:", e, "File:", tr.src);
      };
    }

    function play(){
      audio.play().then(()=>{
        btnPlay.textContent = "Pause";
        setStatus("play", "Playing");
        save();
      }).catch(()=>{
        setStatus("error", "Playback blocked. Click Play.");
      });
    }

    function pause(){
      audio.pause();
      btnPlay.textContent = "Play";
      setStatus("pause", "Paused");
      save();
    }

    function togglePlay(){
      if(audio.paused) play(); else pause();
    }

    function next(){
      if(state.idx < TRACKS.length - 1){
        state.idx++;
        loadTrack(true);
      } else if(state.loop){
        state.idx = 0;
        loadTrack(true);
      } else {
        pause();
      }
    }

    function prev(){
      if(audio.currentTime > 2){
        audio.currentTime = 0;
        return;
      }
      if(state.idx > 0){
        state.idx--;
        loadTrack(true);
      } else if(state.loop){
        state.idx = TRACKS.length - 1;
        loadTrack(true);
      } else {
        audio.currentTime = 0;
      }
    }

    function seekToRatio(r){
      if(!isFinite(audio.duration) || audio.duration <= 0) return;
      audio.currentTime = Math.max(0, Math.min(audio.duration, audio.duration * r));
      save();
    }

    function shuffle(){
      // Fisher-Yates on order
      const arr = [...TRACKS.keys()];
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random() * (i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      // keep current track at top if possible
      const currentReal = currentRealIndex();
      const pos = arr.indexOf(currentReal);
      if(pos > 0){
        arr.splice(pos,1);
        arr.unshift(currentReal);
      }
      state.order = arr;
      state.idx = 0;
      state.shuffled = true;
      renderList();
      loadTrack(false);
      save();
      setStatus("ready","Shuffle on");
    }

    function unshuffle(){
      state.order = [...TRACKS.keys()];
      state.idx = clampIdx(state.order.indexOf(currentRealIndex()));
      state.shuffled = false;
      renderList();
      updateActiveRow();
      save();
      setStatus("ready","Shuffle off");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== Events ======
    btnPlay.addEventListener("click", togglePlay);
    btnNext.addEventListener("click", next);
    btnPrev.addEventListener("click", prev);

    btnRew.addEventListener("click", ()=> { audio.currentTime = Math.max(0, (audio.currentTime||0) - 10); save(); });
    btnFwd.addEventListener("click", ()=> { audio.currentTime = Math.min(audio.duration||0, (audio.currentTime||0) + 10); save(); });

    // Touch and click support for progress bar
    function handleSeek(e){
      const rect = bar.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const r = (clientX - rect.left) / rect.width;
      seekToRatio(r);
    }

    bar.addEventListener("click", handleSeek);
    bar.addEventListener("touchstart", (e)=>{
      e.preventDefault();
      handleSeek(e);
    });

    // Swipe gestures for next/prev
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    document.addEventListener("touchstart", (e)=>{
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});

    document.addEventListener("touchend", (e)=>{
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    }, {passive: true});

    function handleSwipe(){
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const minSwipeDistance = 50;

      // Only trigger if horizontal swipe is dominant
      if(Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance){
        if(deltaX > 0){
          prev();
        } else {
          next();
        }
      }
    }

    vol.addEventListener("input", ()=>{
      state.volume = Number(vol.value);
      audio.volume = state.volume;
      volVal.textContent = Math.round(state.volume*100) + "%";
      save();
    });

    btnLoop.addEventListener("click", ()=>{
      state.loop = !state.loop;
      btnLoop.textContent = "Loop: " + (state.loop ? "On" : "Off");
      modeText.textContent = state.loop ? "Loop" : "Linear";
      save();
    });

    btnShuffle.addEventListener("click", ()=>{
      if(!state.shuffled) shuffle();
      else unshuffle();
    });

    function updateVideoDisplay(){
      const video = $("bgVideo");
      if(state.windowMode){
        video.classList.add("window-mode");
        video.style.display = "block";
      } else {
        video.classList.remove("window-mode");
        video.style.display = state.bg ? "block" : "none";
      }
    }

    btnWindowMode.addEventListener("click", ()=>{
      state.windowMode = !state.windowMode;
      updateVideoDisplay();
      btnWindowMode.textContent = "Window: " + (state.windowMode ? "On" : "Off");
      save();
    });

    btnBgToggle.addEventListener("click", ()=>{
      state.bg = !state.bg;
      if(!state.windowMode){
        $("bgVideo").style.display = state.bg ? "block" : "none";
      }
      btnBgToggle.textContent = "BG: " + (state.bg ? "On" : "Off");
      
      // Load video if enabling and not in lazy mode
      if (state.bg && !state.slowMode.lazyLoad && !state.slowMode.disableVideo) {
        loadNextVideo(true);
      }
      
      save();
    });

    btnCopy.addEventListener("click", async ()=>{
      const tr = TRACKS[currentRealIndex()];
      const text = `${tr.title} ‚Äî ${tr.artist} (${tr.mood})`;
      try{
        await navigator.clipboard.writeText(text);
        setStatus("ready","Copied track info");
      }catch{
        setStatus("error","Clipboard blocked");
      }
    });

    btnClearMem.addEventListener("click", ()=>{
      localStorage.removeItem(KEY);
      location.reload();
    });

    btnAddDemo.addEventListener("click", ()=>{
      setStatus("ready","Edit TRACKS[] in the HTML to add your real files.");
    });

    // ====== Bandwidth Detection ======
    function detectBandwidth() {
      if (!navigator.connection && !navigator.mozConnection && !navigator.webkitConnection) {
        if (bandwidthStatus) bandwidthStatus.textContent = "Connection API not available";
        state.slowMode.bandwidth = 'unknown';
        return;
      }
      
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const effectiveType = connection.effectiveType || 'unknown';
      const downlink = connection.downlink || 0;
      
      state.slowMode.bandwidth = effectiveType;
      
      let statusText = `Connection: ${effectiveType}`;
      if (downlink > 0) {
        statusText += ` (${downlink.toFixed(1)} Mbps)`;
      }
      
      // Auto-enable slow mode options for slow connections
      if (effectiveType === 'slow-2g' || effectiveType === '2g' || (downlink > 0 && downlink < 1.5)) {
        if (optLazyLoad) optLazyLoad.checked = true;
        state.slowMode.lazyLoad = true;
        if (bandwidthStatus) bandwidthStatus.textContent = statusText + " - Slow connection detected";
        setStatus("ready", "Slow connection detected. Lazy loading enabled.");
      } else {
        if (bandwidthStatus) bandwidthStatus.textContent = statusText;
      }
      
      // Listen for connection changes
      connection.addEventListener('change', detectBandwidth);
    }

    // ====== Slow Mode Toggle ======
    if (btnSlowMode) {
      btnSlowMode.addEventListener("click", ()=>{
        if (!slowModePanel) return;
        const isVisible = slowModePanel.style.display !== 'none';
        slowModePanel.style.display = isVisible ? 'none' : 'block';
        btnSlowMode.textContent = isVisible ? 'Slow Mode' : 'Hide Options';
      });
    }

    // ====== Slow Mode Options ======
    if (optDisableVideo) {
      optDisableVideo.addEventListener("change", (e)=>{
        state.slowMode.disableVideo = e.target.checked;
        if (state.slowMode.disableVideo) {
          if (bgVideo) bgVideo.style.display = 'none';
          setStatus("ready", "Video disabled for bandwidth savings");
        } else {
          updateVideoDisplay();
          loadNextVideo(true);
        }
        save();
      });
    }

    if (optLazyLoad) {
      optLazyLoad.addEventListener("change", (e)=>{
        state.slowMode.lazyLoad = e.target.checked;
        if (bgVideo) {
          bgVideo.preload = state.slowMode.lazyLoad ? 'none' : 'auto';
        }
        if (!state.slowMode.lazyLoad && state.bg) {
          loadNextVideo(true);
        }
        save();
      });
    }

    if (optLowQuality) {
      optLowQuality.addEventListener("change", (e)=>{
        state.slowMode.lowQuality = e.target.checked;
        if (state.bg || state.windowMode) {
          loadNextVideo(true);
        }
        save();
      });
    }

    if (optPreloadAudio) {
      optPreloadAudio.addEventListener("change", (e)=>{
        state.slowMode.preloadAudio = e.target.checked;
        if (audio) {
          audio.preload = state.slowMode.preloadAudio ? 'auto' : 'metadata';
        }
        save();
      });
    }

    // Preload next audio track if enabled
    let nextAudioPreload = null;
    function preloadNextAudio() {
      if (!state.slowMode.preloadAudio || !audio) return;
      
      const nextIdx = state.idx < TRACKS.length - 1 ? state.idx + 1 : (state.loop ? 0 : -1);
      if (nextIdx < 0 || nextIdx >= TRACKS.length) return;
      
      const nextTrack = TRACKS[state.order[nextIdx]];
      if (!nextTrack || !nextTrack.src) return;
      
      // Create hidden audio element for preloading
      if (nextAudioPreload) {
        nextAudioPreload.src = '';
        nextAudioPreload.load();
      }
      
      nextAudioPreload = document.createElement('audio');
      nextAudioPreload.preload = 'auto';
      nextAudioPreload.src = encodeURI(nextTrack.src);
      nextAudioPreload.load();
    }

    // Audio time updates
    if (audio) {
      audio.addEventListener("timeupdate", ()=>{
        if (!audio || !tCur || !fill) return;
        const cur = audio.currentTime || 0;
        const dur = audio.duration || 0;
        if (tCur) tCur.textContent = fmtTime(cur);
        if(isFinite(dur) && dur>0 && fill){
          fill.style.width = (cur/dur*100).toFixed(3) + "%";
        }
        if(Math.floor(cur) % 2 === 0) save(); // light save

        // Fake combat + loot reactions
        const shield = document.getElementById("shieldBar");
        const health = document.getElementById("healthBar");

        if (shield && Math.random() > 0.985) {
          shield.style.width = (60 + Math.random()*40) + "%";
        }
        if (health && Math.random() > 0.995) {
          health.style.width = (50 + Math.random()*30) + "%";
        }
      });
    }

    audio.addEventListener("ended", ()=>{
      if(state.loop || state.idx < TRACKS.length - 1){
        next();
      }else{
        pause();
      }
    });

    // Video cycling - loops through all videos independently
    bgVideo.addEventListener("ended", ()=>{
      loadNextVideo();
    });

    // Keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if(tag === "input" || tag === "textarea") return;

      if(e.code === "Space"){ e.preventDefault(); togglePlay(); }
      if(e.code === "ArrowRight"){ e.preventDefault(); next(); }
      if(e.code === "ArrowLeft"){ e.preventDefault(); prev(); }
      if(e.key.toLowerCase() === "j"){ audio.currentTime = Math.max(0, (audio.currentTime||0) - 10); save(); }
      if(e.key.toLowerCase() === "l"){ audio.currentTime = Math.min(audio.duration||0, (audio.currentTime||0) + 10); save(); }
      if(e.key.toLowerCase() === "m"){
        audio.muted = !audio.muted;
        setStatus("ready", audio.muted ? "Muted" : "Unmuted");
      }
    });

    // ====== Boot ======
    (function init(){
      // Detect bandwidth first
      detectBandwidth();
      
      load();

      // Initialize slow mode UI
      if (optDisableVideo) optDisableVideo.checked = state.slowMode.disableVideo;
      if (optLazyLoad) optLazyLoad.checked = state.slowMode.lazyLoad;
      if (optLowQuality) optLowQuality.checked = state.slowMode.lowQuality;
      if (optPreloadAudio) optPreloadAudio.checked = state.slowMode.preloadAudio;
      
      // Set audio preload based on settings
      if (audio) {
        audio.preload = state.slowMode.preloadAudio ? 'auto' : 'metadata';
      }

      // apply state UI
      audio.volume = state.volume;
      vol.value = String(state.volume);
      volVal.textContent = Math.round(state.volume*100) + "%";
      btnLoop.textContent = "Loop: " + (state.loop ? "On" : "Off");
      updateVideoDisplay();
      btnWindowMode.textContent = "Window: " + (state.windowMode ? "On" : "Off");
      btnBgToggle.textContent = "BG: " + (state.bg ? "On" : "Off");
      
      // Initialize first video (only if not lazy loading or video is enabled)
      if (!state.slowMode.lazyLoad || state.bg || state.windowMode) {
        if (!state.slowMode.disableVideo) {
          loadNextVideo();
        }
      }

      // if previously shuffled, keep order (render accordingly)
      renderList();
      loadTrack(false);

      // If user had been playing, we won't auto-play (browser rules), but we restore position.
      setStatus("ready","Ready. Click Play.");
    })();
  </script>
</body>
</html>

